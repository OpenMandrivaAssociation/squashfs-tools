From 17f01bfe6317dedd25ee04c0b8f7727ba09134ce Mon Sep 17 00:00:00 2001
From: Phillip Lougher <phillip@squashfs.org.uk>
Date: Sun, 24 Aug 2014 02:06:51 +0100
Subject: [PATCH 067/120] actions: implement verbose_action for stat_fn test
 operator

Signed-off-by: Phillip Lougher <phillip@squashfs.org.uk>
---
 squashfs-tools/action.c     | 21 ++++++++++++++++++---
 squashfs-tools/mksquashfs.c |  2 +-
 2 files changed, 19 insertions(+), 4 deletions(-)

diff --git a/squashfs-tools/action.c b/squashfs-tools/action.c
index 23e0c5d..115eec6 100644
--- a/squashfs-tools/action.c
+++ b/squashfs-tools/action.c
@@ -2768,7 +2768,7 @@ static int stat_fn(struct atom *atom, struct action_data *action_data)
 {
 	struct stat buf;
 	struct action_data eval_action;
-	int res;
+	int match, res;
 
 	/* evaluate the expression using the context of the inode
 	 * pointed to by the symlink.  This allows the inode attributes
@@ -2786,15 +2786,30 @@ static int stat_fn(struct atom *atom, struct action_data *action_data)
 	 * information, i.e. stat(expr) == expr.  This is harmless and
 	 * is better than returning TRUE or FALSE in a non symlink case */
 	res = stat(action_data->pathname, &buf);
-	if(res == -1)
+	if(res == -1) {
+		if(expr_log_cmnd(LOG_ENABLED)) {
+			expr_log(atom->test->name);
+			expr_log("(");
+			expr_log_match(0);
+			expr_log(")");
+		}
 		return 0;
+	}
 
 	/* fill in the inode values of the file pointed to by the
 	 * symlink, but, leave everything else the same */
 	memcpy(&eval_action, action_data, sizeof(struct action_data));
 	eval_action.buf = &buf;
 
-	return eval_expr(atom->data, &eval_action);
+	if(expr_log_cmnd(LOG_ENABLED)) {
+		expr_log(atom->test->name);
+		expr_log("(");
+		match = eval_expr_log(atom->data, &eval_action);
+		expr_log(")");
+	} else
+		match = eval_expr(atom->data, &eval_action);
+
+	return match;
 }
 
 
diff --git a/squashfs-tools/mksquashfs.c b/squashfs-tools/mksquashfs.c
index 93ab9aa..c5f4d73 100644
--- a/squashfs-tools/mksquashfs.c
+++ b/squashfs-tools/mksquashfs.c
@@ -5089,7 +5089,7 @@ void calculate_queue_sizes(int mem, int *readq, int *fragq, int *bwriteq,
 
 
 #define VERSION() \
-	printf("mksquashfs version 4.3-git (2014/08/22)\n");\
+	printf("mksquashfs version 4.3-git (2014/08/23)\n");\
 	printf("copyright (C) 2014 Phillip Lougher "\
 		"<phillip@squashfs.org.uk>\n\n"); \
 	printf("This program is free software; you can redistribute it and/or"\
-- 
2.8.3

