From 5db907390716d1dc7d57cac5734a9b1ed315ea06 Mon Sep 17 00:00:00 2001
From: Phillip Lougher <phillip@squashfs.org.uk>
Date: Sat, 23 Aug 2014 03:53:50 +0100
Subject: [PATCH 066/120] actions: implement verbose_action for readlink_fn
 test operator

Signed-off-by: Phillip Lougher <phillip@squashfs.org.uk>
---
 squashfs-tools/action.c     | 24 ++++++++++++++++++++----
 squashfs-tools/mksquashfs.c |  2 +-
 2 files changed, 21 insertions(+), 5 deletions(-)

diff --git a/squashfs-tools/action.c b/squashfs-tools/action.c
index 1e5dbe4..23e0c5d 100644
--- a/squashfs-tools/action.c
+++ b/squashfs-tools/action.c
@@ -2800,7 +2800,7 @@ static int stat_fn(struct atom *atom, struct action_data *action_data)
 
 static int readlink_fn(struct atom *atom, struct action_data *action_data)
 {
-	int match;
+	int match = 0;
 	struct dir_ent *dir_ent;
 	struct action_data eval_action;
 
@@ -2820,13 +2820,13 @@ static int readlink_fn(struct atom *atom, struct action_data *action_data)
 	 *
 	 * readlink operates on symlinks only */
 	if (!file_type_match(action_data->buf->st_mode, ACTION_LNK))
-		return 0;
+		goto finish;
 
 	/* dereference the symlink, and get the directory entry it points to */
 	dir_ent = follow_path(action_data->dir_ent->our_dir,
 			action_data->dir_ent->inode->symlink);
 	if(dir_ent == NULL)
-		return 0;
+		goto finish;
 
 	eval_action.name = dir_ent->name;
 	eval_action.pathname = strdup(pathname(dir_ent));
@@ -2836,12 +2836,28 @@ static int readlink_fn(struct atom *atom, struct action_data *action_data)
 	eval_action.dir_ent = dir_ent;
 	eval_action.root = action_data->root;
 
-	match = eval_expr(atom->data, &eval_action);
+	if(expr_log_cmnd(LOG_ENABLED)) {
+		expr_log(atom->test->name);
+		expr_log("(");
+		match = eval_expr_log(atom->data, &eval_action);
+		expr_log(")");
+	} else
+		match = eval_expr(atom->data, &eval_action);
 
 	free(eval_action.pathname);
 	free(eval_action.subpath);
 
 	return match;
+
+finish:
+	if(expr_log_cmnd(LOG_ENABLED)) {
+		expr_log(atom->test->name);
+		expr_log("(");
+		expr_log_match(0);
+		expr_log(")");
+	}
+
+	return 0;
 }
 
 
diff --git a/squashfs-tools/mksquashfs.c b/squashfs-tools/mksquashfs.c
index 7b80858..93ab9aa 100644
--- a/squashfs-tools/mksquashfs.c
+++ b/squashfs-tools/mksquashfs.c
@@ -5089,7 +5089,7 @@ void calculate_queue_sizes(int mem, int *readq, int *fragq, int *bwriteq,
 
 
 #define VERSION() \
-	printf("mksquashfs version 4.3-git (2014/08/21)\n");\
+	printf("mksquashfs version 4.3-git (2014/08/22)\n");\
 	printf("copyright (C) 2014 Phillip Lougher "\
 		"<phillip@squashfs.org.uk>\n\n"); \
 	printf("This program is free software; you can redistribute it and/or"\
-- 
2.8.3

