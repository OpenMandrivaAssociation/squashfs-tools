From 5b2a8f40a8ee7ffca7c6ada1d8535dfc5a3941aa Mon Sep 17 00:00:00 2001
From: Phillip Lougher <phillip@squashfs.org.uk>
Date: Mon, 8 Sep 2014 02:11:45 +0100
Subject: [PATCH 093/120] actions: refactor parse_octal_mode_args(), to use it
 with the perm test function

Signed-off-by: Phillip Lougher <phillip@squashfs.org.uk>
---
 squashfs-tools/action.c | 31 ++++++++++++++++++-------------
 1 file changed, 18 insertions(+), 13 deletions(-)

diff --git a/squashfs-tools/action.c b/squashfs-tools/action.c
index 4265d52..8d596ac 100644
--- a/squashfs-tools/action.c
+++ b/squashfs-tools/action.c
@@ -1184,29 +1184,36 @@ static void guid_action(struct action *action, struct dir_ent *dir_ent)
 /*
  * Mode specific action code
  */
-static int parse_octal_mode_args(unsigned int mode, int bytes, int args,
-					char **argv, void **data)
+static int parse_octal_mode_args(int args, char **argv, void **data)
 {
+	int n, bytes;
+	unsigned int mode;
 	struct mode_data *mode_data;
 
+	/* octal mode number? */
+	n = sscanf(argv[0], "%o%n", &mode, &bytes);
+	if (n == 0)
+		return -1; /* not an octal number arg */
+
+
 	/* check there's no trailing junk */
 	if (argv[0][bytes] != '\0') {
 		SYNTAX_ERROR("Unexpected trailing bytes after octal "
 			"mode number\n");
-		return 0;
+		return 0; /* bad octal number arg */
 	}
 
 	/* check there's only one argument */
 	if (args > 1) {
 		SYNTAX_ERROR("Octal mode number is first argument, "
 			"expected one argument, got %d\n", args);
-		return 0;
+		return 0; /* bad octal number arg */
 	}
 
 	/*  check mode is within range */
 	if (mode > 07777) {
 		SYNTAX_ERROR("Octal mode %o is out of range\n", mode);
-		return 0;
+		return 0; /* bad octal number arg */
 	}
 
 	mode_data = malloc(sizeof(struct mode_data));
@@ -1377,20 +1384,18 @@ static int parse_sym_mode_args(struct action_entry *action, int args,
 static int parse_mode_args(struct action_entry *action, int args,
 					char **argv, void **data)
 {
-	int n, bytes;
-	unsigned int mode;
+	int res;
 
 	if (args == 0) {
 		SYNTAX_ERROR("Mode action expects one or more arguments\n");
 		return 0;
 	}
 
-	/* octal mode number? */
-	n = sscanf(argv[0], "%o%n", &mode, &bytes);
-
-	if(n >= 1)
-		return parse_octal_mode_args(mode, bytes, args, argv, data);
-	else
+	res = parse_octal_mode_args(args, argv, data);
+	if(res >= 0)
+		/* Got an octal mode argument */
+		return res;
+	else  /* not an octal mode argument */
 		return parse_sym_mode_args(action, args, argv, data);
 }
 
-- 
2.8.3

