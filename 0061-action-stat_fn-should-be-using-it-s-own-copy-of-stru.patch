From d304ba3a4ac273fd56ae51898b1b9abafd39fc8a Mon Sep 17 00:00:00 2001
From: Phillip Lougher <phillip@squashfs.org.uk>
Date: Mon, 11 Aug 2014 01:43:42 +0100
Subject: [PATCH 061/120] action: stat_fn should be using it's own copy of
 struct action_data

Signed-off-by: Phillip Lougher <phillip@squashfs.org.uk>
---
 squashfs-tools/action.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/squashfs-tools/action.c b/squashfs-tools/action.c
index 484ea13..fcefa80 100644
--- a/squashfs-tools/action.c
+++ b/squashfs-tools/action.c
@@ -2588,6 +2588,7 @@ static int parse_expr_arg(struct test_entry *test, struct atom *atom)
 static int stat_fn(struct atom *atom, struct action_data *action_data)
 {
 	struct stat buf;
+	struct action_data eval_action;
 	int res;
 
 	/* evaluate the expression using the context of the inode
@@ -2611,9 +2612,10 @@ static int stat_fn(struct atom *atom, struct action_data *action_data)
 
 	/* fill in the inode values of the file pointed to by the
 	 * symlink, but, leave everything else the same */
-	action_data->buf = &buf;
+	memcpy(&eval_action, action_data, sizeof(struct action_data));
+	eval_action.buf = &buf;
 
-	return eval_expr(atom->data, action_data);
+	return eval_expr(atom->data, &eval_action);
 }
 
 
-- 
2.8.3

