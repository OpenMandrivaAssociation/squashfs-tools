From 4995ac5e470068c276c3604c04982185d111ee08 Mon Sep 17 00:00:00 2001
From: Phillip Lougher <phillip@squashfs.org.uk>
Date: Sun, 24 Aug 2014 03:46:46 +0100
Subject: [PATCH 068/120] actions: implement -vaf (verbose action file) option

Signed-off-by: Phillip Lougher <phillip@squashfs.org.uk>
---
 squashfs-tools/action.c     | 13 +++++++++++--
 squashfs-tools/action.h     |  2 +-
 squashfs-tools/mksquashfs.c | 14 ++++++++++++--
 3 files changed, 24 insertions(+), 5 deletions(-)

diff --git a/squashfs-tools/action.c b/squashfs-tools/action.c
index 115eec6..faf3566 100644
--- a/squashfs-tools/action.c
+++ b/squashfs-tools/action.c
@@ -790,15 +790,24 @@ static int eval_expr_top(struct action *action, struct action_data *action_data)
  * 
  * Blank lines and comment lines indicated by # are supported.
  */
+int parse_action_verbose(char *s)
+{
+	return parse_action(s, 1);
+}
+
+
 int parse_action_nonverbose(char *s)
 {
 	return parse_action(s, 0);
 }
 
 
-int read_action_file(char *filename)
+int read_action_file(char *filename, int verbose)
 {
-	return read_file(filename, "action", parse_action_nonverbose);
+	if(verbose)
+		return read_file(filename, "action", parse_action_verbose);
+	else
+		return read_file(filename, "action", parse_action_nonverbose);
 }
 
 
diff --git a/squashfs-tools/action.h b/squashfs-tools/action.h
index f8099f7..4b6e1f8 100644
--- a/squashfs-tools/action.h
+++ b/squashfs-tools/action.h
@@ -296,7 +296,7 @@ extern int read_bytes(int, void *, int);
 extern int actions();
 extern int move_actions();
 extern int empty_actions();
-extern int read_action_file(char *);
+extern int read_action_file(char *, int);
 extern int exclude_actions();
 extern int prune_actions();
 #endif
diff --git a/squashfs-tools/mksquashfs.c b/squashfs-tools/mksquashfs.c
index c5f4d73..d242987 100644
--- a/squashfs-tools/mksquashfs.c
+++ b/squashfs-tools/mksquashfs.c
@@ -5172,7 +5172,7 @@ int main(int argc, char *argv[])
 		else if(strcmp(argv[i], "-root-becomes") == 0 ||
 				strcmp(argv[i], "-ef") == 0 ||
 				strcmp(argv[i], "-pf") == 0 ||
-				strcmp(argv[i], "-af") == 0 ||
+				strcmp(argv[i], "-vaf") == 0 ||
 				strcmp(argv[i], "-comp") == 0)
 			i++;
 	}
@@ -5213,7 +5213,15 @@ int main(int argc, char *argv[])
 				ERROR("%s: -af missing filename\n", argv[0]);
 				exit(1);
 			}
-			if(read_action_file(argv[i]) == FALSE)
+			if(read_action_file(argv[i], 0) == FALSE)
+				exit(1);
+
+		} else if(strcmp(argv[i], "-vaf") == 0) {
+			if(++i == argc) {
+				ERROR("%s: -vaf missing filename\n", argv[0]);
+				exit(1);
+			}
+			if(read_action_file(argv[i], 1) == FALSE)
 				exit(1);
 
 		} else if(strcmp(argv[i], "-comp") == 0)
@@ -5693,6 +5701,7 @@ printOptions:
 				strcmp(argv[i], "-sort") == 0 ||
 				strcmp(argv[i], "-pf") == 0 ||
 				strcmp(argv[i], "-af") == 0 ||
+				strcmp(argv[i], "-vaf") == 0 ||
 				strcmp(argv[i], "-comp") == 0)
 			i++;
 
@@ -5722,6 +5731,7 @@ printOptions:
 				strcmp(argv[i], "-ef") == 0 ||
 				strcmp(argv[i], "-pf") == 0 ||
 				strcmp(argv[i], "-af") == 0 ||
+				strcmp(argv[i], "-vaf") == 0 ||
 				strcmp(argv[i], "-comp") == 0)
 			i++;
 
-- 
2.8.3

